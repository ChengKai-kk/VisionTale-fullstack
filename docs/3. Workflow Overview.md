# 流程概览

## 核心流程一览

```mermaid
flowchart LR
  A[拍照/上传] --> B[头像生成]
  B --> C[语音对话收集需求]
  C --> D[故事生成]
  D --> E[场景拆分]
  E --> F[插图生成]
  F --> G[故事书预览]
  F --> H[视频生成]
```

## Workflow 1: 头像生成

```mermaid
sequenceDiagram
  participant U as User
  participant F as Web App
  participant B as Backend API
  participant Ark as Ark Image API

  U->>F: 选择照片/拍照
  F->>B: POST /api/avatar/stylize/start
  B-->>F: taskId
  B->>Ark: image generations (stylize)
  Ark-->>B: avatarUrl
  B->>B: session.artifacts.avatar
  loop poll
    F->>B: GET /api/task/:id
    B-->>F: task status/progress
  end
```

## Workflow 2: 语音对话 (ASR -> LLM -> TTS)

```mermaid
sequenceDiagram
  participant U as User
  participant F as Web App
  participant B as Backend API
  participant ASR as Volc Speech
  participant LLM as Ark LLM
  participant TTS as DashScope TTS

  U->>F: 按住说话
  F->>B: POST /api/voice/dialog/start
  B-->>F: taskId
  B->>ASR: base64 audio
  ASR-->>B: transcript
  B->>LLM: dialog messages
  LLM-->>B: next question + storyReq
  B->>TTS: assistant text
  TTS-->>B: audio URL
  B->>B: session.artifacts.storyDialog/storyReq/voice.*
  F->>B: GET /api/session/:id (poll)
```

## Workflow 3: 故事 -> 场景 -> 插图

```mermaid
sequenceDiagram
  participant F as Web App
  participant B as Backend API
  participant LLM as Ark LLM
  participant Img as Ark Image API

  F->>B: POST /api/story/generate/start
  B-->>F: taskId
  B->>LLM: storyReq -> story JSON
  LLM-->>B: title/story/moral
  B->>B: session.artifacts.story

  F->>B: POST /api/story/split/start
  B-->>F: taskId
  B->>LLM: story -> scenes JSON
  LLM-->>B: scenes
  B->>B: session.artifacts.scenes

  F->>B: POST /api/image/scenes/start
  B-->>F: taskId
  B->>LLM: decide includeHero
  B->>Img: generate per scene
  Img-->>B: imageUrl
  B->>B: session.artifacts.sceneImages (逐张写回)
  F->>B: GET /api/session/:id (poll)
```

## Workflow 4: 视频生成

```mermaid
sequenceDiagram
  participant F as Web App
  participant B as Backend API
  participant Ark as Ark Video API

  F->>B: POST /api/video/start
  B-->>F: taskId
  B->>Ark: create I2V task
  Ark-->>B: arkTaskId
  loop poll
    B->>Ark: get task
    Ark-->>B: status + videoUrl
  end
  B->>B: session.artifacts.video/videoClips
  F->>B: GET /api/session/:id (poll)
```

## 数据流 (session.artifacts)

```mermaid
flowchart TB
  subgraph Session Artifacts
    A[avatar]
    V1[voice.lastUser]
    V2[voice.lastAssistant]
    V3[voice.lastAssistantAudio]
    D[storyDialog.messages]
    R[storyReq]
    S[story]
    SC[scenes.items]
    SI[sceneImages.items]
    V[video]
    VC[videoClips.items]
  end

  A --> SC
  R --> S
  S --> SC
  SC --> SI
  SI --> VC
```

## 状态管理
- 前端: localStorage 保存 sessionId, 每个页面各自维护状态与轮询
- 后端: MemorySessionStore + MemoryTaskStore, 支持 TTL 与手动 sweep

## 错误处理策略
- 后端: task.status = FAILED, error 字段返回错误原因
- 前端: 轮询失败或超时显示提示; Images 支持局部失败不中断
