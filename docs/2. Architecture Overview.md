# 架构概览

## 系统上下文 (C4 Level 1)

```mermaid
C4Context
  title VisionTale System Context

  Person(user, "User", "Children/parents using the web app")
  System(frontend, "VisionTale Web", "Vue SPA running in browser")
  System(backend, "VisionTale Backend", "Node.js HTTP API")

  System_Ext(ark, "Volc Ark", "LLM/Image/Video generation")
  System_Ext(volc, "Volc Speech", "ASR speech to text")
  System_Ext(dash, "DashScope", "TTS audio generation")

  Rel(user, frontend, "Create storybook")
  Rel(frontend, backend, "HTTP API")
  Rel(backend, ark, "Chat/Image/Video")
  Rel(backend, volc, "ASR")
  Rel(backend, dash, "TTS")
```

## 容器架构 (C4 Level 2)

```mermaid
C4Container
  title VisionTale Container Diagram

  Person(user, "User")
  Container(spa, "Web App", "Vue 3 + Vite", "Step-based UI")
  Container(api, "Backend API", "Node.js", "Task + session orchestration")
  ContainerDb(mem, "Session/Task Store", "In-memory Map", "Ephemeral state")

  System_Ext(ark, "Volc Ark", "LLM/Image/Video")
  System_Ext(volc, "Volc Speech", "ASR")
  System_Ext(dash, "DashScope", "TTS")

  Rel(user, spa, "Uses")
  Rel(spa, api, "REST over HTTP")
  Rel(api, mem, "Read/Write")
  Rel(api, ark, "HTTPS")
  Rel(api, volc, "HTTPS")
  Rel(api, dash, "HTTPS")
```

## 组件关系 (C4 Level 3)

```mermaid
graph TB
  subgraph Backend
    R[router.js]
    SS[SessionService]
    TS[MemoryTaskStore]
    AS[AvatarService]
    VS[VoiceService]
    STS[StoryService]
    IS[ImageService]
    VDS[VideoService]
    IP[ImageProvider]
    VP[VideoProvider]
    LLM[LlmProvider]
    ASR[AsrProvider]
    TTS[QwenTtsProvider]
  end

  R --> SS
  R --> TS
  R --> AS
  R --> VS
  R --> STS
  R --> IS
  R --> VDS

  AS --> IP
  VS --> ASR
  VS --> LLM
  VS --> TTS
  STS --> LLM
  IS --> IP
  IS --> LLM
  VDS --> VP
```

## 架构模式
- Step-based pipeline: 前端按步骤推进, 后端按阶段写入 artifacts
- Task polling: 长任务以 taskId + 轮询获取进度
- Ephemeral state: session/task 保存在内存, 通过 TTL 清理
- Artifact namespaces: session.artifacts 按命名空间聚合结果

## 关键设计决策
1. **session.artifacts 作为统一合同**
   - 理由: 前后端共享结构, 便于跨步骤复用
   - 代价: 需要控制单次写入大小, 需要清晰 namespace 规划
2. **task 轮询替代实时推送**
   - 理由: 实现简单, 兼容无 WebSocket 环境
   - 代价: 前端需多次轮询, 增加延迟
3. **localStorage 维持 sessionId**
   - 理由: 页面刷新或跨路由保留流程状态
   - 代价: 无跨设备同步

## 模块拆分
- `visiontale_backend`: API 路由、会话与任务存储、生成服务与 Provider
- `visiontale_front`: Vue SPA, 路由步骤与 UI 组件
